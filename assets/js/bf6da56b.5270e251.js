"use strict";(self.webpackChunkdifranca=self.webpackChunkdifranca||[]).push([[396],{7266:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>l});var a=t(5893),r=t(1151);const s={keywords:["terraform","iac","backend","state"],title:"Backends | Terraform | Cloud | Tech-Notes",sidebar_label:"Backends"},i="Backends",o={id:"cloud/terraform/backend",title:"Backends | Terraform | Cloud | Tech-Notes",description:"Backends define where Terraform's state snapshots are stored.",source:"@site/docs/tech/cloud/terraform/backend.md",sourceDirName:"cloud/terraform",slug:"/cloud/terraform/backend",permalink:"/tech-notes/cloud/terraform/backend",draft:!1,unlisted:!1,editUrl:"https://github.com/difranca/difranca.github.io/blob/main/docs/tech/cloud/terraform/backend.md",tags:[],version:"current",frontMatter:{keywords:["terraform","iac","backend","state"],title:"Backends | Terraform | Cloud | Tech-Notes",sidebar_label:"Backends"},sidebar:"tech",previous:{title:"Terraform",permalink:"/tech-notes/cloud/terraform"},next:{title:"DevSecOps",permalink:"/tech-notes/devsecops"}},c={},l=[{value:"Example Configuration",id:"example-configuration",level:2},{value:"Change Backend",id:"change-backend",level:2},{value:"Example",id:"example",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.a)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h1,{id:"backends",children:"Backends"}),"\n",(0,a.jsx)(n.p,{children:"Backends define where Terraform's state snapshots are stored."}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"A configuration can only provide one backend block"}),"\n",(0,a.jsxs)(n.li,{children:["The default backend is ",(0,a.jsx)(n.code,{children:"local"}),", which stores state as a plain file"]}),"\n"]}),"\n",(0,a.jsx)(n.admonition,{title:"More Information",type:"note",children:(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://www.terraform.io/language/settings/backends",children:"https://www.terraform.io/language/settings/backends"})}),"\n"]})}),"\n",(0,a.jsx)("br",{}),"\n",(0,a.jsx)(n.h2,{id:"example-configuration",children:"Example Configuration"}),"\n",(0,a.jsxs)(n.p,{children:["The following example assumes that there is a bucket called ",(0,a.jsx)(n.code,{children:"state-bucket"})," in ",(0,a.jsx)(n.code,{children:"us-east-1"})," region.\nThe Terraform state will be written to the key ",(0,a.jsx)(n.code,{children:"path/to/my/key"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-hcl",metastring:'title="backend.tf"',children:'terraform {\n  backend "s3" {\n    bucket = "state-bucket"\n    key    = "path/to/my/key"\n    region = "us-east-1"\n  }\n}\n'})}),"\n",(0,a.jsx)("br",{}),"\n",(0,a.jsx)(n.h2,{id:"change-backend",children:"Change Backend"}),"\n",(0,a.jsx)(n.p,{children:'You can change both the backend configuration itself as well as the type of backend (e.g. from "consul" to "s3") at any time.'}),"\n",(0,a.jsx)(n.p,{children:"Terraform will automatically detect any changes in your configuration and request a reinitialization."}),"\n",(0,a.jsx)(n.h3,{id:"example",children:"Example"}),"\n",(0,a.jsx)(n.p,{children:'Let\'s take as an example a simple module that is using a local backend on file "state01.tfstate":'}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-hcl",metastring:'title="main.tf"',children:'terraform {\n  backend "local" {\n    path = "state01.tfstate"\n  }\n}\n\noutput "test" {\n  value = "first"\n}\n'})}),"\n",(0,a.jsx)("br",{}),"\n",(0,a.jsxs)(n.p,{children:["After a ",(0,a.jsx)(n.code,{children:"terraform apply"}),", the following state will be created."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",metastring:'title="state01.tfstate"',children:'{\n  "version": 4,\n  "terraform_version": "1.1.7",\n  "serial": 1,\n  "lineage": "8f056ed4-e12f-05a5-f57c-b2e859e136d1",\n  "outputs": {\n    "test": {\n      "value": "first",\n      "type": "string"\n    }\n  },\n  "resources": []\n}\n'})}),"\n",(0,a.jsx)("br",{}),"\n",(0,a.jsx)(n.p,{children:'Let\'s change the backend file to "state02.tfstate" and the value of the "test" output from the value "first" to "second".'}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-hcl",metastring:'title="main.tf"',children:'terraform {\n  backend "local" {\n    path = "state02.tfstate"\n  }\n}\n\noutput "test" {\n  value = "second"\n}\n'})}),"\n",(0,a.jsx)("br",{}),"\n",(0,a.jsxs)(n.p,{children:["If you try to run a ",(0,a.jsx)(n.code,{children:"terraform plan"})," or ",(0,a.jsx)(n.code,{children:"terraform apply"}),", you will get the following error message:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'\u2502 Error: Backend initialization required: please run "terraform init"\n\u2502\n\u2502 Reason: Backend configuration block has changed\n'})}),"\n",(0,a.jsx)(n.p,{children:"Now, there are two options to change the state backend:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"-reconfigure            Reconfigure a backend, ignoring any saved configuration.\n-migrate-state          Reconfigure a backend, and attempt to migrate any existing state.\n"})}),"\n",(0,a.jsx)("br",{}),"\n",(0,a.jsx)(n.p,{children:"Let's try to migrate the existing state:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'> terraform init -migrate-state\n\nInitializing the backend...\nBackend configuration changed!\n\nTerraform has detected that the configuration specified for the backend\nhas changed. Terraform will now check for existing state in the backends.\n\nDo you want to copy existing state to the new backend?\n  Pre-existing state was found while migrating the previous "local" backend to the\n  newly configured "local" backend. No existing state was found in the newly\n  configured "local" backend. Do you want to copy this state to the new "local"\n  backend? Enter "yes" to copy and "no" to start with an empty state.\n'})}),"\n",(0,a.jsx)(n.admonition,{type:"tip",children:(0,a.jsxs)(n.p,{children:["The copy confirmation prompt can be suppressed using the ",(0,a.jsx)(n.code,{children:"-force-copy"})," argument."]})}),"\n",(0,a.jsx)("br",{}),"\n",(0,a.jsx)(n.p,{children:"After confirming the copy, the new state backend will be created:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",metastring:'title="state02.tfstate"',children:'{\n  "version": 4,\n  "terraform_version": "1.1.7",\n  "serial": 1,\n  "lineage": "b12425fd-9445-c004-4d1b-c4f17eefc0fb",\n  "outputs": {\n    "test": {\n      "value": "first",\n      "type": "string"\n    }\n  },\n  "resources": []\n}\n'})}),"\n",(0,a.jsx)("br",{}),"\n",(0,a.jsxs)(n.p,{children:["Now you can use ",(0,a.jsx)(n.code,{children:"terraform plan"})," and ",(0,a.jsx)(n.code,{children:"terraform apply"})," again.\nAfter applying the new configuration, the new state backend will be update:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",metastring:'title="state02.tfstate"',children:'{\n  "version": 4,\n  "terraform_version": "1.1.7",\n  "serial": 2,\n  "lineage": "b12425fd-9445-c004-4d1b-c4f17eefc0fb",\n  "outputs": {\n    "test": {\n      "value": "second",\n      "type": "string"\n    }\n  },\n  "resources": []\n}\n'})}),"\n",(0,a.jsx)(n.admonition,{type:"info",children:(0,a.jsxs)(n.p,{children:["Note that after the ",(0,a.jsx)(n.code,{children:"migrate-state"})," command, the previous state was only copied, not moved.\nTherefore, the old state backend still exists with the old content, and you can be manually delete it if desired."]})}),"\n",(0,a.jsx)("br",{}),"\n",(0,a.jsx)(n.admonition,{title:"More Information",type:"note",children:(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://www.terraform.io/language/settings/backends/configuration#changing-configuration",children:"https://www.terraform.io/language/settings/backends/configuration#changing-configuration"})}),"\n"]})})]})}function h(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>o,a:()=>i});var a=t(7294);const r={},s=a.createContext(r);function i(e){const n=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);