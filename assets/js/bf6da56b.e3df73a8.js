"use strict";(self.webpackChunkdifranca=self.webpackChunkdifranca||[]).push([[396],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return u}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),m=c(n),u=r,f=m["".concat(s,".").concat(u)]||m[u]||p[u]||o;return n?a.createElement(f,i(i({ref:t},d),{},{components:n})):a.createElement(f,i({ref:t},d))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},1673:function(e,t,n){n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return s},default:function(){return u},frontMatter:function(){return l},metadata:function(){return c},toc:function(){return p}});var a=n(7462),r=n(3366),o=(n(7294),n(3905)),i=["components"],l={keywords:["terraform","iac","backend","state"]},s="Backends",c={unversionedId:"cloud/terraform/backend",id:"cloud/terraform/backend",title:"Backends",description:"Backends define where Terraform's state snapshots are stored.",source:"@site/docs/tech/cloud/terraform/backend.md",sourceDirName:"cloud/terraform",slug:"/cloud/terraform/backend",permalink:"/tech-notes/cloud/terraform/backend",draft:!1,editUrl:"https://github.com/difranca/difranca.github.io/blob/main/docs/tech/cloud/terraform/backend.md",tags:[],version:"current",frontMatter:{keywords:["terraform","iac","backend","state"]},sidebar:"tech",previous:{title:"Terraform",permalink:"/tech-notes/cloud/terraform"},next:{title:"\u267e DevSecOps",permalink:"/tech-notes/devsecops"}},d={},p=[{value:"Example Configuration",id:"example-configuration",level:2},{value:"Change Backend",id:"change-backend",level:2},{value:"Example",id:"example",level:3}],m={toc:p};function u(e){var t=e.components,n=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"backends"},"Backends"),(0,o.kt)("p",null,"Backends define where Terraform's state snapshots are stored."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"A configuration can only provide one backend block"),(0,o.kt)("li",{parentName:"ul"},"The default backend is ",(0,o.kt)("inlineCode",{parentName:"li"},"local"),", which stores state as a plain file")),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"More Information")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("ul",{parentName:"div"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.terraform.io/language/settings/backends"},"https://www.terraform.io/language/settings/backends"))))),(0,o.kt)("br",null),(0,o.kt)("h2",{id:"example-configuration"},"Example Configuration"),(0,o.kt)("p",null,"The following example assumes that there is a bucket called ",(0,o.kt)("inlineCode",{parentName:"p"},"state-bucket")," in ",(0,o.kt)("inlineCode",{parentName:"p"},"us-east-1")," region.\nThe Terraform state will be written to the key ",(0,o.kt)("inlineCode",{parentName:"p"},"path/to/my/key"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-hcl",metastring:'title="backend.tf"',title:'"backend.tf"'},'terraform {\n  backend "s3" {\n    bucket = "state-bucket"\n    key    = "path/to/my/key"\n    region = "us-east-1"\n  }\n}\n')),(0,o.kt)("br",null),(0,o.kt)("h2",{id:"change-backend"},"Change Backend"),(0,o.kt)("p",null,'You can change both the backend configuration itself as well as the type of backend (e.g. from "consul" to "s3") at any time.'),(0,o.kt)("p",null,"Terraform will automatically detect any changes in your configuration and request a reinitialization."),(0,o.kt)("h3",{id:"example"},"Example"),(0,o.kt)("p",null,'Let\'s take as an example a simple module that is using a local backend on file "state01.tfstate":'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-hcl",metastring:'title="main.tf"',title:'"main.tf"'},'terraform {\n  backend "local" {\n    path = "state01.tfstate"\n  }\n}\n\noutput "test" {\n  value = "first"\n}\n')),(0,o.kt)("br",null),(0,o.kt)("p",null,"After a ",(0,o.kt)("inlineCode",{parentName:"p"},"terraform apply"),", the following state will be created."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="state01.tfstate"',title:'"state01.tfstate"'},'{\n  "version": 4,\n  "terraform_version": "1.1.7",\n  "serial": 1,\n  "lineage": "8f056ed4-e12f-05a5-f57c-b2e859e136d1",\n  "outputs": {\n    "test": {\n      "value": "first",\n      "type": "string"\n    }\n  },\n  "resources": []\n}\n')),(0,o.kt)("br",null),(0,o.kt)("p",null,'Let\'s change the backend file to "state02.tfstate" and the value of the "test" output from the value "first" to "second".'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-hcl",metastring:'title="main.tf"',title:'"main.tf"'},'terraform {\n  backend "local" {\n    path = "state02.tfstate"\n  }\n}\n\noutput "test" {\n  value = "second"\n}\n')),(0,o.kt)("br",null),(0,o.kt)("p",null,"If you try to run a ",(0,o.kt)("inlineCode",{parentName:"p"},"terraform plan")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"terraform apply"),", you will get the following error message:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'\u2502 Error: Backend initialization required: please run "terraform init"\n\u2502\n\u2502 Reason: Backend configuration block has changed\n')),(0,o.kt)("p",null,"Now, there are two options to change the state backend:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"-reconfigure            Reconfigure a backend, ignoring any saved configuration.\n-migrate-state          Reconfigure a backend, and attempt to migrate any existing state.\n")),(0,o.kt)("br",null),(0,o.kt)("p",null,"Let's try to migrate the existing state:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'> terraform init -migrate-state\n\nInitializing the backend...\nBackend configuration changed!\n\nTerraform has detected that the configuration specified for the backend\nhas changed. Terraform will now check for existing state in the backends.\n\nDo you want to copy existing state to the new backend?\n  Pre-existing state was found while migrating the previous "local" backend to the\n  newly configured "local" backend. No existing state was found in the newly\n  configured "local" backend. Do you want to copy this state to the new "local"\n  backend? Enter "yes" to copy and "no" to start with an empty state.\n')),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"The copy confirmation prompt can be suppressed using the ",(0,o.kt)("inlineCode",{parentName:"p"},"-force-copy")," argument."))),(0,o.kt)("br",null),(0,o.kt)("p",null,"After confirming the copy, the new state backend will be created:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="state02.tfstate"',title:'"state02.tfstate"'},'{\n  "version": 4,\n  "terraform_version": "1.1.7",\n  "serial": 1,\n  "lineage": "b12425fd-9445-c004-4d1b-c4f17eefc0fb",\n  "outputs": {\n    "test": {\n      "value": "first",\n      "type": "string"\n    }\n  },\n  "resources": []\n}\n')),(0,o.kt)("br",null),(0,o.kt)("p",null,"Now you can use ",(0,o.kt)("inlineCode",{parentName:"p"},"terraform plan")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"terraform apply")," again.\nAfter applying the new configuration, the new state backend will be update:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="state02.tfstate"',title:'"state02.tfstate"'},'{\n  "version": 4,\n  "terraform_version": "1.1.7",\n  "serial": 2,\n  "lineage": "b12425fd-9445-c004-4d1b-c4f17eefc0fb",\n  "outputs": {\n    "test": {\n      "value": "second",\n      "type": "string"\n    }\n  },\n  "resources": []\n}\n')),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Note that after the ",(0,o.kt)("inlineCode",{parentName:"p"},"migrate-state")," command, the previous state was only copied, not moved.\nTherefore, the old state backend still exists with the old content, and you can be manually delete it if desired."))),(0,o.kt)("br",null),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"More Information")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("ul",{parentName:"div"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.terraform.io/language/settings/backends/configuration#changing-configuration"},"https://www.terraform.io/language/settings/backends/configuration#changing-configuration"))))))}u.isMDXComponent=!0}}]);